// Prisma Schema for P2P Energy Trading
// PostgreSQL database with proper relations and indexes

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Authentication Models
// ============================================

model User {
  id              String    @id @default(uuid())
  phone           String    @unique
  name            String?
  profileComplete Boolean   @default(false) @map("profile_complete")
  balance         Float     @default(10000) // Account balance in INR
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  lastLoginAt     DateTime? @map("last_login_at")

  // Trust score system (like credit score)
  trustScore          Float     @default(0.3) @map("trust_score")          // 0.0 - 1.0
  allowedTradeLimit   Float     @default(10.0) @map("allowed_trade_limit") // % of surplus allowed
  baselineTrustScore  Float     @default(0.3) @map("baseline_trust_score") // Initial score from meter analysis
  meterDataAnalyzed   Boolean   @default(false) @map("meter_data_analyzed")
  
  // Production capacity (kWh per month)
  productionCapacity    Float?    @map("production_capacity")       // User-declared production
  meterVerifiedCapacity Float?    @map("meter_verified_capacity")   // Verified from meter PDF
  meterPdfUrl           String?   @map("meter_pdf_url")             // Uploaded meter PDF path

  // Multi-credential onboarding fields
  // From UtilityCustomerCredential
  consumerNumber        String?   @map("consumer_number")
  meterNumber           String?   @map("meter_number")
  installationAddress   String?   @map("installation_address")
  serviceConnectionDate DateTime? @map("service_connection_date")

  // From ConsumptionProfileCredential
  premisesType          String?   @map("premises_type")        // Residential/Commercial/Industrial/Agricultural
  connectionType        String?   @map("connection_type")      // Single-phase/Three-phase
  sanctionedLoadKW      Float?    @map("sanctioned_load_kw")
  tariffCategoryCode    String?   @map("tariff_category_code")

  // From StorageProfileCredential
  storageCapacityKWh    Float?    @map("storage_capacity_kwh")
  storagePowerRatingKW  Float?    @map("storage_power_rating_kw")
  storageType           String?   @map("storage_type")         // LithiumIon/LeadAcid/FlowBattery/Other

  // From UtilityProgramEnrollmentCredential
  programName           String?   @map("program_name")
  programCode           String?   @map("program_code")
  programEnrollmentDate DateTime? @map("program_enrollment_date")
  programValidUntil     DateTime? @map("program_valid_until")

  // Prosumer can be both provider and consumer
  provider   Provider? @relation(fields: [providerId], references: [id])
  providerId String?   @unique @map("provider_id")

  // User's orders as buyer
  orders      Order[]
  sessions    Session[]
  credentials UserCredential[]
  trustHistory    TrustScoreHistory[]
  discomFeedback  DiscomFeedback[]
  buyerPayments  PaymentRecord[] @relation("BuyerPayments")
  sellerPayments PaymentRecord[] @relation("SellerPayments")

  @@index([phone])
  @@map("users")
}

model Session {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  token      String   @unique
  deviceInfo String?  @map("device_info")
  ipAddress  String?  @map("ip_address")
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

// ============================================
// Verifiable Credentials
// ============================================

enum CredentialType {
  UTILITY_CUSTOMER
  CONSUMPTION_PROFILE
  GENERATION_PROFILE
  STORAGE_PROFILE
  PROGRAM_ENROLLMENT
}

model UserCredential {
  id              String         @id @default(uuid())
  userId          String         @map("user_id")
  credentialType  CredentialType @map("credential_type")
  rawJson         String         @map("raw_json")
  verified        Boolean        @default(false)
  verifiedAt      DateTime?      @map("verified_at")
  extractedClaims String?        @map("extracted_claims")
  issuerId        String?        @map("issuer_id")
  issuanceDate    DateTime?      @map("issuance_date")
  createdAt       DateTime       @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, credentialType])
  @@index([userId])
  @@map("user_credentials")
}

// ============================================
// Business Models
// ============================================

model Provider {
  id               String   @id
  name             String
  trustScore       Float    @default(0.5) @map("trust_score")
  totalOrders      Int      @default(0) @map("total_orders")
  successfulOrders Int      @default(0) @map("successful_orders")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Link to user (prosumer who created this provider profile)
  user User?

  items  CatalogItem[]
  offers CatalogOffer[]
  orders Order[]
  blocks OfferBlock[]

  @@map("providers")
}

model CatalogItem {
  id                    String   @id
  providerId            String   @map("provider_id")
  sourceType            String   @map("source_type")
  deliveryMode          String   @map("delivery_mode")
  availableQty          Float    @map("available_qty")
  meterId               String?  @map("meter_id")
  productionWindowsJson String   @map("production_windows_json")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  provider Provider       @relation(fields: [providerId], references: [id], onDelete: Cascade)
  offers   CatalogOffer[]
  blocks   OfferBlock[]

  @@index([providerId])
  @@map("catalog_items")
}

model CatalogOffer {
  id              String   @id
  itemId          String   @map("item_id")
  providerId      String   @map("provider_id")
  priceValue      Float    @map("price_value")
  currency        String   @default("INR")
  maxQty          Float    @map("max_qty")
  timeWindowStart DateTime @map("time_window_start")
  timeWindowEnd   DateTime @map("time_window_end")
  pricingModel    String   @default("PER_KWH") @map("pricing_model")
  settlementType  String   @default("DAILY") @map("settlement_type")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  item     CatalogItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  provider Provider     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  blocks   OfferBlock[]
  orders   Order[]

  @@index([itemId])
  @@index([providerId])
  @@map("catalog_offers")
}

model OfferBlock {
  id            String    @id
  offerId       String    @map("offer_id")
  itemId        String    @map("item_id")
  providerId    String    @map("provider_id")
  status        String    @default("AVAILABLE")
  orderId       String?   @map("order_id")
  transactionId String?   @map("transaction_id")
  priceValue    Float     @map("price_value")
  currency      String    @default("INR")
  version       Int       @default(0) // Optimistic locking version
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  reservedAt    DateTime? @map("reserved_at")
  soldAt        DateTime? @map("sold_at")

  offer    CatalogOffer @relation(fields: [offerId], references: [id], onDelete: Cascade)
  item     CatalogItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  provider Provider     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  order    Order?       @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([offerId])
  @@index([offerId, status])
  @@index([orderId])
  @@index([transactionId])
  @@map("offer_blocks")
}

model Order {
  id              String   @id
  transactionId   String   @unique @map("transaction_id")
  providerId      String?  @map("provider_id")
  selectedOfferId String?  @map("selected_offer_id")
  buyerId         String?  @map("buyer_id") // User who placed the order
  status          String   @default("DRAFT")
  totalQty        Float?   @map("total_qty")
  totalPrice      Float?   @map("total_price")
  currency        String?
  itemsJson       String   @map("items_json")
  quoteJson       String   @map("quote_json")
  version         Int      @default(0) // Optimistic locking version
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Cancellation tracking
  cancelledAt     DateTime? @map("cancelled_at")
  cancelledBy     String?   @map("cancelled_by")  // 'BUYER' | 'SELLER' | 'SYSTEM'
  cancelReason    String?   @map("cancel_reason")
  cancelPenalty   Float?    @map("cancel_penalty") // Total penalty amount
  cancelRefund    Float?    @map("cancel_refund")  // Amount refunded to buyer
  
  // Payment tracking (escrow)
  paymentStatus   String    @default("PENDING") @map("payment_status") // PENDING | ESCROWED | RELEASED | REFUNDED
  escrowedAt      DateTime? @map("escrowed_at")
  releasedAt      DateTime? @map("released_at")
  
  // DISCOM verification
  discomVerified  Boolean   @default(false) @map("discom_verified")

  provider      Provider?     @relation(fields: [providerId], references: [id], onDelete: SetNull)
  selectedOffer CatalogOffer? @relation(fields: [selectedOfferId], references: [id], onDelete: SetNull)
  buyer         User?         @relation(fields: [buyerId], references: [id], onDelete: SetNull)
  blocks        OfferBlock[]
  payments      PaymentRecord[]

  @@index([providerId])
  @@index([buyerId])
  @@index([status])
  @@index([paymentStatus])
  @@map("orders")
}

model Event {
  id            Int      @id @default(autoincrement())
  transactionId String   @map("transaction_id")
  messageId     String   @map("message_id")
  action        String
  direction     String
  rawJson       String   @map("raw_json")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([transactionId])
  @@index([messageId, direction])
  @@map("events")
}

// ============================================
// Settlement Records (Phase 4 - Payment Flow)
// ============================================

model SettlementRecord {
  id                  String    @id @default(uuid())
  tradeId             String    @unique @map("trade_id")
  orderId             String?   @map("order_id")
  transactionId       String?   @map("transaction_id")
  buyerId             String?   @map("buyer_id")
  sellerId            String?   @map("seller_id")
  principal           Float
  fee                 Float
  total               Float
  expiresAt           String?   @map("expires_at")
  status              String    @default("INITIATED")
  verificationOutcome String?   @map("verification_outcome")
  fundedReceipt       String?   @map("funded_receipt")
  payoutReceipt       String?   @map("payout_receipt")
  fundedAt            String?   @map("funded_at")
  verifiedAt          String?   @map("verified_at")
  payoutAt            String?   @map("payout_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Verifiable Credentials metadata
  vcId                String?   @map("vc_id")        // ID of the verified VC
  vcIssuer            String?   @map("vc_issuer")    // DID of the VC issuer
  vcVerifiedAt        String?   @map("vc_verified_at") // When VC was verified
  vcClaims            String?   @map("vc_claims")    // JSON string of extracted claims

  @@index([orderId])
  @@index([transactionId])
  @@index([status])
  @@index([vcId])
  @@map("settlement_records")
}

// ============================================
// Trust Score System
// ============================================

model TrustScoreHistory {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  previousScore Float    @map("previous_score")
  newScore      Float    @map("new_score")
  previousLimit Float    @map("previous_limit")
  newLimit      Float    @map("new_limit")
  reason        String   // 'SIGNUP' | 'METER_ANALYSIS' | 'DELIVERY_SUCCESS' | 'DELIVERY_PARTIAL' | 'DELIVERY_FAILED' | 'BUYER_CANCEL'
  orderId       String?  @map("order_id")
  metadata      String?  // JSON with details (deliveredQty, expectedQty, etc)
  createdAt     DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([orderId])
  @@map("trust_score_history")
}

model DiscomFeedback {
  id              String   @id @default(uuid())
  orderId         String   @unique @map("order_id")
  sellerId        String   @map("seller_id")
  transactionId   String   @map("transaction_id")
  deliveredQty    Float    @map("delivered_qty")
  expectedQty     Float    @map("expected_qty")
  deliveryRatio   Float    @map("delivery_ratio")  // deliveredQty/expectedQty
  status          String   // 'FULL' | 'PARTIAL' | 'FAILED'
  trustImpact     Float    @map("trust_impact")    // Actual penalty/bonus applied
  verifiedAt      DateTime @map("verified_at")
  createdAt       DateTime @default(now()) @map("created_at")

  seller User @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId])
  @@index([orderId])
  @@map("discom_feedback")
}

// Payment records for tracking money flow
model PaymentRecord {
  id              String   @id @default(uuid())
  type            String   // 'ESCROW' | 'RELEASE' | 'CANCEL_PENALTY' | 'REFUND' | 'SELLER_CANCEL_REFUND' | 'SELLER_CANCEL_PENALTY'
  orderId         String   @map("order_id")
  buyerId         String?  @map("buyer_id")
  sellerId        String?  @map("seller_id")
  
  // Amounts
  totalAmount     Float    @map("total_amount")     // Original order amount
  buyerRefund     Float?   @map("buyer_refund")     // Amount returned to buyer
  sellerAmount    Float?   @map("seller_amount")    // Amount paid to seller
  platformFee     Float?   @map("platform_fee")     // Platform's share
  
  // Status
  status          String   @default("PENDING")      // PENDING | COMPLETED | FAILED
  completedAt     DateTime? @map("completed_at")
  createdAt       DateTime @default(now()) @map("created_at")
  
  // Relations
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  buyer           User?    @relation("BuyerPayments", fields: [buyerId], references: [id], onDelete: SetNull)
  seller          User?    @relation("SellerPayments", fields: [sellerId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([type])
  @@map("payment_records")
}

// ============================================
// Chat / Oorja Agent
// ============================================

enum ChatPlatform {
  TELEGRAM
  WEB
}

enum ChatState {
  GREETING
  WAITING_PHONE
  WAITING_OTP
  WAITING_NAME
  OTP_VERIFIED
  EXPLAIN_VC
  WAITING_VC_UPLOAD
  VC_VERIFIED
  CONFIRM_TRADING
  TRADING_ACTIVE
  GENERAL_CHAT
}

model ChatSession {
  id          String       @id @default(uuid())
  userId      String?      @map("user_id")
  platform    ChatPlatform
  platformId  String?      @map("platform_id")
  state       ChatState    @default(GREETING)
  contextJson String       @default("{}") @map("context_json")
  authToken   String?      @map("auth_token")
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  messages    ChatMessage[]

  @@unique([platform, platformId])
  @@index([userId])
  @@map("chat_sessions")
}

model ChatMessage {
  id           String      @id @default(uuid())
  sessionId    String      @map("session_id")
  role         String
  content      String
  metadataJson String?     @map("metadata_json")
  createdAt    DateTime    @default(now()) @map("created_at")
  session      ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("chat_messages")
}
