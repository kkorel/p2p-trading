// Prisma Schema for P2P Energy Trading
// PostgreSQL database with proper relations and indexes

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Provider {
  id               String   @id
  name             String
  trustScore       Float    @default(0.5) @map("trust_score")
  totalOrders      Int      @default(0) @map("total_orders")
  successfulOrders Int      @default(0) @map("successful_orders")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  items  CatalogItem[]
  offers CatalogOffer[]
  orders Order[]
  blocks OfferBlock[]

  @@map("providers")
}

model CatalogItem {
  id                    String   @id
  providerId            String   @map("provider_id")
  sourceType            String   @map("source_type")
  deliveryMode          String   @map("delivery_mode")
  availableQty          Float    @map("available_qty")
  meterId               String?  @map("meter_id")
  productionWindowsJson String   @map("production_windows_json")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  provider Provider       @relation(fields: [providerId], references: [id], onDelete: Cascade)
  offers   CatalogOffer[]
  blocks   OfferBlock[]

  @@index([providerId])
  @@map("catalog_items")
}

model CatalogOffer {
  id              String   @id
  itemId          String   @map("item_id")
  providerId      String   @map("provider_id")
  priceValue      Float    @map("price_value")
  currency        String   @default("USD")
  maxQty          Float    @map("max_qty")
  timeWindowStart DateTime @map("time_window_start")
  timeWindowEnd   DateTime @map("time_window_end")
  pricingModel    String   @default("PER_KWH") @map("pricing_model")
  settlementType  String   @default("DAILY") @map("settlement_type")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  item     CatalogItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  provider Provider     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  blocks   OfferBlock[]
  orders   Order[]

  @@index([itemId])
  @@index([providerId])
  @@map("catalog_offers")
}

model OfferBlock {
  id            String    @id
  offerId       String    @map("offer_id")
  itemId        String    @map("item_id")
  providerId    String    @map("provider_id")
  status        String    @default("AVAILABLE")
  orderId       String?   @map("order_id")
  transactionId String?   @map("transaction_id")
  priceValue    Float     @map("price_value")
  currency      String    @default("USD")
  version       Int       @default(0) // Optimistic locking version
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  reservedAt    DateTime? @map("reserved_at")
  soldAt        DateTime? @map("sold_at")

  offer    CatalogOffer @relation(fields: [offerId], references: [id], onDelete: Cascade)
  item     CatalogItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  provider Provider     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  order    Order?       @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([offerId])
  @@index([offerId, status])
  @@index([orderId])
  @@index([transactionId])
  @@map("offer_blocks")
}

model Order {
  id              String   @id
  transactionId   String   @unique @map("transaction_id")
  providerId      String?  @map("provider_id")
  selectedOfferId String?  @map("selected_offer_id")
  status          String   @default("DRAFT")
  totalQty        Float?   @map("total_qty")
  totalPrice      Float?   @map("total_price")
  currency        String?
  itemsJson       String   @map("items_json")
  quoteJson       String   @map("quote_json")
  version         Int      @default(0) // Optimistic locking version
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  provider          Provider?          @relation(fields: [providerId], references: [id], onDelete: SetNull)
  selectedOffer     CatalogOffer?      @relation(fields: [selectedOfferId], references: [id], onDelete: SetNull)
  blocks            OfferBlock[]
  verificationCases VerificationCase[]
  settlements       Settlement[]

  @@index([providerId])
  @@index([status])
  @@map("orders")
}

model Event {
  id            Int      @id @default(autoincrement())
  transactionId String   @map("transaction_id")
  messageId     String   @map("message_id")
  action        String
  direction     String
  rawJson       String   @map("raw_json")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([transactionId])
  @@index([messageId, direction])
  @@map("events")
}

// ============ PHASE-3: VERIFICATION & SETTLEMENT ============

model VerificationCase {
  id                String   @id
  orderId           String   @map("order_id")
  transactionId     String   @map("transaction_id")
  state             String   @default("PENDING")
  requiredProofsJson String  @map("required_proofs_json")
  toleranceRulesJson String  @map("tolerance_rules_json")
  windowJson        String   @map("window_json")
  expectedQty       Float    @map("expected_qty")
  deliveredQty      Float?   @map("delivered_qty")
  deviationQty      Float?   @map("deviation_qty")
  deviationPercent  Float?   @map("deviation_percent")
  decision          String?
  decidedAt         DateTime? @map("decided_at")
  expiresAt         DateTime  @map("expires_at")
  rejectionReason   String?   @map("rejection_reason")
  rawJson           String    @map("raw_json")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  order  Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  proofs Proof[]
  settlements Settlement[]

  @@index([orderId])
  @@map("verification_cases")
}

model Proof {
  id                String   @id
  verificationCaseId String  @map("verification_case_id")
  type              String
  payloadJson       String    @map("payload_json")
  source            String
  quantityValue     Float?    @map("quantity_value")
  timestamp         DateTime
  receivedAt        DateTime  @default(now()) @map("received_at")
  hash              String?
  rawJson           String    @map("raw_json")

  verificationCase VerificationCase @relation(fields: [verificationCaseId], references: [id], onDelete: Cascade)

  @@index([verificationCaseId])
  @@map("proofs")
}

model Settlement {
  id                String   @id
  orderId           String   @map("order_id")
  verificationCaseId String? @map("verification_case_id")
  transactionId     String   @map("transaction_id")
  settlementType     String   @map("settlement_type")
  state             String   @default("INITIATED")
  amountValue       Float    @map("amount_value")
  currency          String
  periodJson        String?  @map("period_json")
  breakdownJson     String?  @map("breakdown_json")
  initiatedAt       DateTime @default(now()) @map("initiated_at")
  completedAt       DateTime? @map("completed_at")
  rawJson           String    @map("raw_json")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  order            Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  verificationCase VerificationCase? @relation(fields: [verificationCaseId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@map("settlements")
}
