"use strict";
/**
 * SQLite Database Schema for P2P Energy Trading
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.SCHEMA = void 0;
exports.initializeSchema = initializeSchema;
exports.SCHEMA = {
    // Providers table - tracks BPP trust scores
    providers: `
    CREATE TABLE IF NOT EXISTS providers (
      id TEXT PRIMARY KEY,
      name TEXT NOT NULL,
      trust_score REAL DEFAULT 0.5,
      total_orders INTEGER DEFAULT 0,
      successful_orders INTEGER DEFAULT 0,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `,
    // Catalog items table
    catalog_items: `
    CREATE TABLE IF NOT EXISTS catalog_items (
      id TEXT PRIMARY KEY,
      provider_id TEXT NOT NULL,
      source_type TEXT NOT NULL,
      delivery_mode TEXT NOT NULL,
      available_qty REAL NOT NULL,
      meter_id TEXT,
      production_windows_json TEXT NOT NULL,
      raw_json TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (provider_id) REFERENCES providers(id)
    )
  `,
    // Catalog offers table
    catalog_offers: `
    CREATE TABLE IF NOT EXISTS catalog_offers (
      id TEXT PRIMARY KEY,
      item_id TEXT NOT NULL,
      provider_id TEXT NOT NULL,
      price_value REAL NOT NULL,
      currency TEXT NOT NULL,
      max_qty REAL NOT NULL,
      time_window_json TEXT NOT NULL,
      offer_attributes_json TEXT NOT NULL,
      raw_json TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (item_id) REFERENCES catalog_items(id),
      FOREIGN KEY (provider_id) REFERENCES providers(id)
    )
  `,
    // Orders table
    orders: `
    CREATE TABLE IF NOT EXISTS orders (
      id TEXT PRIMARY KEY,
      transaction_id TEXT UNIQUE NOT NULL,
      status TEXT NOT NULL DEFAULT 'DRAFT',
      provider_id TEXT,
      selected_offer_id TEXT,
      total_qty REAL,
      total_price REAL,
      currency TEXT,
      raw_json TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (provider_id) REFERENCES providers(id),
      FOREIGN KEY (selected_offer_id) REFERENCES catalog_offers(id)
    )
  `,
    // Events table for logging
    events: `
    CREATE TABLE IF NOT EXISTS events (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      transaction_id TEXT NOT NULL,
      message_id TEXT NOT NULL,
      action TEXT NOT NULL,
      direction TEXT NOT NULL CHECK(direction IN ('OUTBOUND', 'INBOUND')),
      raw_json TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `,
    // Offer blocks table - represents individual 1-unit blocks for granular trading
    offer_blocks: `
    CREATE TABLE IF NOT EXISTS offer_blocks (
      id TEXT PRIMARY KEY,
      offer_id TEXT NOT NULL,
      item_id TEXT NOT NULL,
      provider_id TEXT NOT NULL,
      status TEXT NOT NULL DEFAULT 'AVAILABLE' CHECK(status IN ('AVAILABLE', 'RESERVED', 'SOLD')),
      order_id TEXT,
      transaction_id TEXT,
      price_value REAL NOT NULL,
      currency TEXT NOT NULL,
      time_window_json TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      reserved_at DATETIME,
      sold_at DATETIME,
      FOREIGN KEY (offer_id) REFERENCES catalog_offers(id),
      FOREIGN KEY (item_id) REFERENCES catalog_items(id),
      FOREIGN KEY (provider_id) REFERENCES providers(id),
      FOREIGN KEY (order_id) REFERENCES orders(id)
    )
  `,
    // Settlement records - manual escrow flow (Phase 4)
    settlement_records: `
    CREATE TABLE IF NOT EXISTS settlement_records (
      trade_id TEXT PRIMARY KEY,
      order_id TEXT,
      transaction_id TEXT,
      buyer_id TEXT,
      seller_id TEXT,
      principal REAL NOT NULL,
      fee REAL NOT NULL,
      total REAL NOT NULL,
      expires_at DATETIME NOT NULL,
      status TEXT NOT NULL,
      verification_outcome TEXT,
      funded_receipt TEXT,
      payout_receipt TEXT,
      funded_at DATETIME,
      verified_at DATETIME,
      payout_at DATETIME,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `,
    // Index for faster event lookups
    events_index: `
    CREATE INDEX IF NOT EXISTS idx_events_transaction_id ON events(transaction_id)
  `,
    events_message_index: `
    CREATE INDEX IF NOT EXISTS idx_events_message_id ON events(message_id)
  `,
    // Indexes for offer blocks
    blocks_offer_index: `
    CREATE INDEX IF NOT EXISTS idx_blocks_offer_id ON offer_blocks(offer_id)
  `,
    blocks_status_index: `
    CREATE INDEX IF NOT EXISTS idx_blocks_status ON offer_blocks(offer_id, status)
  `,
    settlement_trade_index: `
    CREATE INDEX IF NOT EXISTS idx_settlement_trade_id ON settlement_records(trade_id)
  `,
};
/**
 * Initialize database with all tables (works with sql.js)
 */
function initializeSchema(db) {
    db.run(exports.SCHEMA.providers);
    db.run(exports.SCHEMA.catalog_items);
    db.run(exports.SCHEMA.catalog_offers);
    db.run(exports.SCHEMA.orders);
    db.run(exports.SCHEMA.events);
    db.run(exports.SCHEMA.offer_blocks);
    db.run(exports.SCHEMA.settlement_records);
    db.run(exports.SCHEMA.events_index);
    db.run(exports.SCHEMA.events_message_index);
    db.run(exports.SCHEMA.blocks_offer_index);
    db.run(exports.SCHEMA.blocks_status_index);
    db.run(exports.SCHEMA.settlement_trade_index);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZW1hLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2NoZW1hLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7O0FBK0hILDRDQVdDO0FBeElZLFFBQUEsTUFBTSxHQUFHO0lBQ3BCLDRDQUE0QztJQUM1QyxTQUFTLEVBQUU7Ozs7Ozs7Ozs7R0FVVjtJQUVELHNCQUFzQjtJQUN0QixhQUFhLEVBQUU7Ozs7Ozs7Ozs7Ozs7R0FhZDtJQUVELHVCQUF1QjtJQUN2QixjQUFjLEVBQUU7Ozs7Ozs7Ozs7Ozs7OztHQWVmO0lBRUQsZUFBZTtJQUNmLE1BQU0sRUFBRTs7Ozs7Ozs7Ozs7Ozs7OztHQWdCUDtJQUVELDJCQUEyQjtJQUMzQixNQUFNLEVBQUU7Ozs7Ozs7Ozs7R0FVUDtJQUVELGdGQUFnRjtJQUNoRixZQUFZLEVBQUU7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBb0JiO0lBRUQsaUNBQWlDO0lBQ2pDLFlBQVksRUFBRTs7R0FFYjtJQUVELG9CQUFvQixFQUFFOztHQUVyQjtJQUVELDJCQUEyQjtJQUMzQixrQkFBa0IsRUFBRTs7R0FFbkI7SUFFRCxtQkFBbUIsRUFBRTs7R0FFcEI7Q0FDRixDQUFDO0FBRUY7O0dBRUc7QUFDSCxTQUFnQixnQkFBZ0IsQ0FBQyxFQUFPO0lBQ3RDLEVBQUUsQ0FBQyxHQUFHLENBQUMsY0FBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3pCLEVBQUUsQ0FBQyxHQUFHLENBQUMsY0FBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzdCLEVBQUUsQ0FBQyxHQUFHLENBQUMsY0FBTSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQzlCLEVBQUUsQ0FBQyxHQUFHLENBQUMsY0FBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3RCLEVBQUUsQ0FBQyxHQUFHLENBQUMsY0FBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3RCLEVBQUUsQ0FBQyxHQUFHLENBQUMsY0FBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQzVCLEVBQUUsQ0FBQyxHQUFHLENBQUMsY0FBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQzVCLEVBQUUsQ0FBQyxHQUFHLENBQUMsY0FBTSxDQUFDLG9CQUFvQixDQUFDLENBQUM7SUFDcEMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxjQUFNLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUNsQyxFQUFFLENBQUMsR0FBRyxDQUFDLGNBQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBQ3JDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFNRTGl0ZSBEYXRhYmFzZSBTY2hlbWEgZm9yIFAyUCBFbmVyZ3kgVHJhZGluZ1xuICovXG5cbmV4cG9ydCBjb25zdCBTQ0hFTUEgPSB7XG4gIC8vIFByb3ZpZGVycyB0YWJsZSAtIHRyYWNrcyBCUFAgdHJ1c3Qgc2NvcmVzXG4gIHByb3ZpZGVyczogYFxuICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIHByb3ZpZGVycyAoXG4gICAgICBpZCBURVhUIFBSSU1BUlkgS0VZLFxuICAgICAgbmFtZSBURVhUIE5PVCBOVUxMLFxuICAgICAgdHJ1c3Rfc2NvcmUgUkVBTCBERUZBVUxUIDAuNSxcbiAgICAgIHRvdGFsX29yZGVycyBJTlRFR0VSIERFRkFVTFQgMCxcbiAgICAgIHN1Y2Nlc3NmdWxfb3JkZXJzIElOVEVHRVIgREVGQVVMVCAwLFxuICAgICAgY3JlYXRlZF9hdCBEQVRFVElNRSBERUZBVUxUIENVUlJFTlRfVElNRVNUQU1QLFxuICAgICAgdXBkYXRlZF9hdCBEQVRFVElNRSBERUZBVUxUIENVUlJFTlRfVElNRVNUQU1QXG4gICAgKVxuICBgLFxuICBcbiAgLy8gQ2F0YWxvZyBpdGVtcyB0YWJsZVxuICBjYXRhbG9nX2l0ZW1zOiBgXG4gICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgY2F0YWxvZ19pdGVtcyAoXG4gICAgICBpZCBURVhUIFBSSU1BUlkgS0VZLFxuICAgICAgcHJvdmlkZXJfaWQgVEVYVCBOT1QgTlVMTCxcbiAgICAgIHNvdXJjZV90eXBlIFRFWFQgTk9UIE5VTEwsXG4gICAgICBkZWxpdmVyeV9tb2RlIFRFWFQgTk9UIE5VTEwsXG4gICAgICBhdmFpbGFibGVfcXR5IFJFQUwgTk9UIE5VTEwsXG4gICAgICBtZXRlcl9pZCBURVhULFxuICAgICAgcHJvZHVjdGlvbl93aW5kb3dzX2pzb24gVEVYVCBOT1QgTlVMTCxcbiAgICAgIHJhd19qc29uIFRFWFQgTk9UIE5VTEwsXG4gICAgICBjcmVhdGVkX2F0IERBVEVUSU1FIERFRkFVTFQgQ1VSUkVOVF9USU1FU1RBTVAsXG4gICAgICBGT1JFSUdOIEtFWSAocHJvdmlkZXJfaWQpIFJFRkVSRU5DRVMgcHJvdmlkZXJzKGlkKVxuICAgIClcbiAgYCxcbiAgXG4gIC8vIENhdGFsb2cgb2ZmZXJzIHRhYmxlXG4gIGNhdGFsb2dfb2ZmZXJzOiBgXG4gICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgY2F0YWxvZ19vZmZlcnMgKFxuICAgICAgaWQgVEVYVCBQUklNQVJZIEtFWSxcbiAgICAgIGl0ZW1faWQgVEVYVCBOT1QgTlVMTCxcbiAgICAgIHByb3ZpZGVyX2lkIFRFWFQgTk9UIE5VTEwsXG4gICAgICBwcmljZV92YWx1ZSBSRUFMIE5PVCBOVUxMLFxuICAgICAgY3VycmVuY3kgVEVYVCBOT1QgTlVMTCxcbiAgICAgIG1heF9xdHkgUkVBTCBOT1QgTlVMTCxcbiAgICAgIHRpbWVfd2luZG93X2pzb24gVEVYVCBOT1QgTlVMTCxcbiAgICAgIG9mZmVyX2F0dHJpYnV0ZXNfanNvbiBURVhUIE5PVCBOVUxMLFxuICAgICAgcmF3X2pzb24gVEVYVCBOT1QgTlVMTCxcbiAgICAgIGNyZWF0ZWRfYXQgREFURVRJTUUgREVGQVVMVCBDVVJSRU5UX1RJTUVTVEFNUCxcbiAgICAgIEZPUkVJR04gS0VZIChpdGVtX2lkKSBSRUZFUkVOQ0VTIGNhdGFsb2dfaXRlbXMoaWQpLFxuICAgICAgRk9SRUlHTiBLRVkgKHByb3ZpZGVyX2lkKSBSRUZFUkVOQ0VTIHByb3ZpZGVycyhpZClcbiAgICApXG4gIGAsXG4gIFxuICAvLyBPcmRlcnMgdGFibGVcbiAgb3JkZXJzOiBgXG4gICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgb3JkZXJzIChcbiAgICAgIGlkIFRFWFQgUFJJTUFSWSBLRVksXG4gICAgICB0cmFuc2FjdGlvbl9pZCBURVhUIFVOSVFVRSBOT1QgTlVMTCxcbiAgICAgIHN0YXR1cyBURVhUIE5PVCBOVUxMIERFRkFVTFQgJ0RSQUZUJyxcbiAgICAgIHByb3ZpZGVyX2lkIFRFWFQsXG4gICAgICBzZWxlY3RlZF9vZmZlcl9pZCBURVhULFxuICAgICAgdG90YWxfcXR5IFJFQUwsXG4gICAgICB0b3RhbF9wcmljZSBSRUFMLFxuICAgICAgY3VycmVuY3kgVEVYVCxcbiAgICAgIHJhd19qc29uIFRFWFQgTk9UIE5VTEwsXG4gICAgICBjcmVhdGVkX2F0IERBVEVUSU1FIERFRkFVTFQgQ1VSUkVOVF9USU1FU1RBTVAsXG4gICAgICB1cGRhdGVkX2F0IERBVEVUSU1FIERFRkFVTFQgQ1VSUkVOVF9USU1FU1RBTVAsXG4gICAgICBGT1JFSUdOIEtFWSAocHJvdmlkZXJfaWQpIFJFRkVSRU5DRVMgcHJvdmlkZXJzKGlkKSxcbiAgICAgIEZPUkVJR04gS0VZIChzZWxlY3RlZF9vZmZlcl9pZCkgUkVGRVJFTkNFUyBjYXRhbG9nX29mZmVycyhpZClcbiAgICApXG4gIGAsXG4gIFxuICAvLyBFdmVudHMgdGFibGUgZm9yIGxvZ2dpbmdcbiAgZXZlbnRzOiBgXG4gICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgZXZlbnRzIChcbiAgICAgIGlkIElOVEVHRVIgUFJJTUFSWSBLRVkgQVVUT0lOQ1JFTUVOVCxcbiAgICAgIHRyYW5zYWN0aW9uX2lkIFRFWFQgTk9UIE5VTEwsXG4gICAgICBtZXNzYWdlX2lkIFRFWFQgTk9UIE5VTEwsXG4gICAgICBhY3Rpb24gVEVYVCBOT1QgTlVMTCxcbiAgICAgIGRpcmVjdGlvbiBURVhUIE5PVCBOVUxMIENIRUNLKGRpcmVjdGlvbiBJTiAoJ09VVEJPVU5EJywgJ0lOQk9VTkQnKSksXG4gICAgICByYXdfanNvbiBURVhUIE5PVCBOVUxMLFxuICAgICAgY3JlYXRlZF9hdCBEQVRFVElNRSBERUZBVUxUIENVUlJFTlRfVElNRVNUQU1QXG4gICAgKVxuICBgLFxuICBcbiAgLy8gT2ZmZXIgYmxvY2tzIHRhYmxlIC0gcmVwcmVzZW50cyBpbmRpdmlkdWFsIDEtdW5pdCBibG9ja3MgZm9yIGdyYW51bGFyIHRyYWRpbmdcbiAgb2ZmZXJfYmxvY2tzOiBgXG4gICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgb2ZmZXJfYmxvY2tzIChcbiAgICAgIGlkIFRFWFQgUFJJTUFSWSBLRVksXG4gICAgICBvZmZlcl9pZCBURVhUIE5PVCBOVUxMLFxuICAgICAgaXRlbV9pZCBURVhUIE5PVCBOVUxMLFxuICAgICAgcHJvdmlkZXJfaWQgVEVYVCBOT1QgTlVMTCxcbiAgICAgIHN0YXR1cyBURVhUIE5PVCBOVUxMIERFRkFVTFQgJ0FWQUlMQUJMRScgQ0hFQ0soc3RhdHVzIElOICgnQVZBSUxBQkxFJywgJ1JFU0VSVkVEJywgJ1NPTEQnKSksXG4gICAgICBvcmRlcl9pZCBURVhULFxuICAgICAgdHJhbnNhY3Rpb25faWQgVEVYVCxcbiAgICAgIHByaWNlX3ZhbHVlIFJFQUwgTk9UIE5VTEwsXG4gICAgICBjdXJyZW5jeSBURVhUIE5PVCBOVUxMLFxuICAgICAgdGltZV93aW5kb3dfanNvbiBURVhUIE5PVCBOVUxMLFxuICAgICAgY3JlYXRlZF9hdCBEQVRFVElNRSBERUZBVUxUIENVUlJFTlRfVElNRVNUQU1QLFxuICAgICAgcmVzZXJ2ZWRfYXQgREFURVRJTUUsXG4gICAgICBzb2xkX2F0IERBVEVUSU1FLFxuICAgICAgRk9SRUlHTiBLRVkgKG9mZmVyX2lkKSBSRUZFUkVOQ0VTIGNhdGFsb2dfb2ZmZXJzKGlkKSxcbiAgICAgIEZPUkVJR04gS0VZIChpdGVtX2lkKSBSRUZFUkVOQ0VTIGNhdGFsb2dfaXRlbXMoaWQpLFxuICAgICAgRk9SRUlHTiBLRVkgKHByb3ZpZGVyX2lkKSBSRUZFUkVOQ0VTIHByb3ZpZGVycyhpZCksXG4gICAgICBGT1JFSUdOIEtFWSAob3JkZXJfaWQpIFJFRkVSRU5DRVMgb3JkZXJzKGlkKVxuICAgIClcbiAgYCxcbiAgXG4gIC8vIEluZGV4IGZvciBmYXN0ZXIgZXZlbnQgbG9va3Vwc1xuICBldmVudHNfaW5kZXg6IGBcbiAgICBDUkVBVEUgSU5ERVggSUYgTk9UIEVYSVNUUyBpZHhfZXZlbnRzX3RyYW5zYWN0aW9uX2lkIE9OIGV2ZW50cyh0cmFuc2FjdGlvbl9pZClcbiAgYCxcbiAgXG4gIGV2ZW50c19tZXNzYWdlX2luZGV4OiBgXG4gICAgQ1JFQVRFIElOREVYIElGIE5PVCBFWElTVFMgaWR4X2V2ZW50c19tZXNzYWdlX2lkIE9OIGV2ZW50cyhtZXNzYWdlX2lkKVxuICBgLFxuICBcbiAgLy8gSW5kZXhlcyBmb3Igb2ZmZXIgYmxvY2tzXG4gIGJsb2Nrc19vZmZlcl9pbmRleDogYFxuICAgIENSRUFURSBJTkRFWCBJRiBOT1QgRVhJU1RTIGlkeF9ibG9ja3Nfb2ZmZXJfaWQgT04gb2ZmZXJfYmxvY2tzKG9mZmVyX2lkKVxuICBgLFxuICBcbiAgYmxvY2tzX3N0YXR1c19pbmRleDogYFxuICAgIENSRUFURSBJTkRFWCBJRiBOT1QgRVhJU1RTIGlkeF9ibG9ja3Nfc3RhdHVzIE9OIG9mZmVyX2Jsb2NrcyhvZmZlcl9pZCwgc3RhdHVzKVxuICBgLFxufTtcblxuLyoqXG4gKiBJbml0aWFsaXplIGRhdGFiYXNlIHdpdGggYWxsIHRhYmxlcyAod29ya3Mgd2l0aCBzcWwuanMpXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbml0aWFsaXplU2NoZW1hKGRiOiBhbnkpOiB2b2lkIHtcbiAgZGIucnVuKFNDSEVNQS5wcm92aWRlcnMpO1xuICBkYi5ydW4oU0NIRU1BLmNhdGFsb2dfaXRlbXMpO1xuICBkYi5ydW4oU0NIRU1BLmNhdGFsb2dfb2ZmZXJzKTtcbiAgZGIucnVuKFNDSEVNQS5vcmRlcnMpO1xuICBkYi5ydW4oU0NIRU1BLmV2ZW50cyk7XG4gIGRiLnJ1bihTQ0hFTUEub2ZmZXJfYmxvY2tzKTtcbiAgZGIucnVuKFNDSEVNQS5ldmVudHNfaW5kZXgpO1xuICBkYi5ydW4oU0NIRU1BLmV2ZW50c19tZXNzYWdlX2luZGV4KTtcbiAgZGIucnVuKFNDSEVNQS5ibG9ja3Nfb2ZmZXJfaW5kZXgpO1xuICBkYi5ydW4oU0NIRU1BLmJsb2Nrc19zdGF0dXNfaW5kZXgpO1xufVxuIl19