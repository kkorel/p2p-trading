"use strict";
/**
 * Redis Client Module
 * Provides connection management, transaction state caching, and message deduplication
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.redis = exports.REDIS_TTL = exports.REDIS_KEYS = void 0;
exports.checkRedisConnection = checkRedisConnection;
exports.connectRedis = connectRedis;
exports.disconnectRedis = disconnectRedis;
exports.createTransactionState = createTransactionState;
exports.getTransactionState = getTransactionState;
exports.updateTransactionState = updateTransactionState;
exports.getAllTransactionStates = getAllTransactionStates;
exports.clearAllTransactionStates = clearAllTransactionStates;
exports.isMessageProcessed = isMessageProcessed;
exports.markMessageProcessed = markMessageProcessed;
const ioredis_1 = __importDefault(require("ioredis"));
// Redis key patterns
exports.REDIS_KEYS = {
    transaction: (id) => `txn:${id}`,
    allTransactions: 'txn:all',
    processedMessage: (messageId, direction) => `msg:${direction}:${messageId}`,
};
// TTL values in seconds
exports.REDIS_TTL = {
    transaction: 24 * 60 * 60, // 24 hours
    processedMessage: 7 * 24 * 60 * 60, // 7 days
};
// Create Redis client singleton
const createRedisClient = () => {
    const redisUrl = process.env.REDIS_URL || 'redis://localhost:6379';
    const client = new ioredis_1.default(redisUrl, {
        maxRetriesPerRequest: 3,
        retryStrategy: (times) => {
            if (times > 10) {
                return null; // Stop retrying
            }
            return Math.min(times * 100, 3000);
        },
        lazyConnect: true,
    });
    client.on('error', (err) => {
        console.error('Redis connection error:', err);
    });
    client.on('connect', () => {
        console.log('Redis connected');
    });
    return client;
};
// Use global variable in development to prevent multiple instances during hot-reload
exports.redis = globalThis.redis ?? createRedisClient();
if (process.env.NODE_ENV !== 'production') {
    globalThis.redis = exports.redis;
}
/**
 * Check if Redis is connected
 */
async function checkRedisConnection() {
    try {
        const pong = await exports.redis.ping();
        return pong === 'PONG';
    }
    catch (error) {
        console.error('Redis connection check failed:', error);
        return false;
    }
}
/**
 * Connect Redis client explicitly
 */
async function connectRedis() {
    if (exports.redis.status !== 'ready') {
        await exports.redis.connect();
    }
}
/**
 * Disconnect Redis client (for graceful shutdown)
 */
async function disconnectRedis() {
    await exports.redis.quit();
}
/**
 * Create a new transaction state in Redis
 */
async function createTransactionState(transactionId) {
    const now = new Date().toISOString();
    const state = {
        transaction_id: transactionId,
        status: 'DISCOVERING',
        created_at: now,
        updated_at: now,
    };
    const key = exports.REDIS_KEYS.transaction(transactionId);
    await exports.redis.set(key, JSON.stringify(state), 'EX', exports.REDIS_TTL.transaction);
    await exports.redis.sadd(exports.REDIS_KEYS.allTransactions, transactionId);
    return state;
}
/**
 * Get transaction state from Redis
 */
async function getTransactionState(transactionId) {
    const key = exports.REDIS_KEYS.transaction(transactionId);
    const data = await exports.redis.get(key);
    if (!data) {
        return null;
    }
    return JSON.parse(data);
}
/**
 * Update transaction state in Redis
 */
async function updateTransactionState(transactionId, updates) {
    const key = exports.REDIS_KEYS.transaction(transactionId);
    const data = await exports.redis.get(key);
    if (!data) {
        return null;
    }
    const state = JSON.parse(data);
    const updatedState = {
        ...state,
        ...updates,
        updated_at: new Date().toISOString(),
    };
    await exports.redis.set(key, JSON.stringify(updatedState), 'EX', exports.REDIS_TTL.transaction);
    return updatedState;
}
/**
 * Get all transaction states from Redis
 */
async function getAllTransactionStates() {
    const transactionIds = await exports.redis.smembers(exports.REDIS_KEYS.allTransactions);
    if (transactionIds.length === 0) {
        return [];
    }
    const keys = transactionIds.map(id => exports.REDIS_KEYS.transaction(id));
    const values = await exports.redis.mget(keys);
    const states = [];
    for (let i = 0; i < values.length; i++) {
        const value = values[i];
        if (value) {
            states.push(JSON.parse(value));
        }
        else {
            // Clean up stale reference
            await exports.redis.srem(exports.REDIS_KEYS.allTransactions, transactionIds[i]);
        }
    }
    return states;
}
/**
 * Clear all transaction states from Redis
 */
async function clearAllTransactionStates() {
    const transactionIds = await exports.redis.smembers(exports.REDIS_KEYS.allTransactions);
    if (transactionIds.length > 0) {
        const keys = transactionIds.map(id => exports.REDIS_KEYS.transaction(id));
        await exports.redis.del(...keys);
    }
    await exports.redis.del(exports.REDIS_KEYS.allTransactions);
}
// ==================== Message Deduplication Operations ====================
/**
 * Check if a message has already been processed (for deduplication)
 */
async function isMessageProcessed(messageId, direction = 'INBOUND') {
    const key = exports.REDIS_KEYS.processedMessage(messageId, direction);
    const exists = await exports.redis.exists(key);
    return exists === 1;
}
/**
 * Mark a message as processed
 */
async function markMessageProcessed(messageId, direction = 'INBOUND') {
    const key = exports.REDIS_KEYS.processedMessage(messageId, direction);
    await exports.redis.set(key, '1', 'EX', exports.REDIS_TTL.processedMessage);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkaXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZWRpcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7Ozs7QUEyREgsb0RBUUM7QUFLRCxvQ0FJQztBQUtELDBDQUVDO0FBd0JELHdEQWNDO0FBS0Qsa0RBU0M7QUFLRCx3REFxQkM7QUFLRCwwREFzQkM7QUFLRCw4REFTQztBQU9ELGdEQUlDO0FBS0Qsb0RBR0M7QUEzTkQsc0RBQTRCO0FBUTVCLHFCQUFxQjtBQUNSLFFBQUEsVUFBVSxHQUFHO0lBQ3hCLFdBQVcsRUFBRSxDQUFDLEVBQVUsRUFBRSxFQUFFLENBQUMsT0FBTyxFQUFFLEVBQUU7SUFDeEMsZUFBZSxFQUFFLFNBQVM7SUFDMUIsZ0JBQWdCLEVBQUUsQ0FBQyxTQUFpQixFQUFFLFNBQWlCLEVBQUUsRUFBRSxDQUFDLE9BQU8sU0FBUyxJQUFJLFNBQVMsRUFBRTtDQUM1RixDQUFDO0FBRUYsd0JBQXdCO0FBQ1gsUUFBQSxTQUFTLEdBQUc7SUFDdkIsV0FBVyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLFdBQVc7SUFDdEMsZ0JBQWdCLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLFNBQVM7Q0FDOUMsQ0FBQztBQUVGLGdDQUFnQztBQUNoQyxNQUFNLGlCQUFpQixHQUFHLEdBQUcsRUFBRTtJQUM3QixNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsSUFBSSx3QkFBd0IsQ0FBQztJQUVuRSxNQUFNLE1BQU0sR0FBRyxJQUFJLGlCQUFLLENBQUMsUUFBUSxFQUFFO1FBQ2pDLG9CQUFvQixFQUFFLENBQUM7UUFDdkIsYUFBYSxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDdkIsSUFBSSxLQUFLLEdBQUcsRUFBRSxFQUFFLENBQUM7Z0JBQ2YsT0FBTyxJQUFJLENBQUMsQ0FBQyxnQkFBZ0I7WUFDL0IsQ0FBQztZQUNELE9BQU8s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QUUsU0FBUyxDQUFDLENBQUM7SUFDOUQsTUFBTSxNQUFNLEdBQUcsTUFBTSxhQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZDLE9BQU8sTUFBTSxLQUFLLENBQUMsQ0FBQztBQUN0QixDQUFDO0FBRUQ7O0dBRUc7QUFDSSxLQUFLLFVBQVUsb0JBQW9CLENBQUMsU0FBaUIsRUFBRSxZQUFvQixTQUFTO0lBQ3pGLE1BQU0sR0FBRyxHQUFHLGtCQUFVLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQzlELE1BQU0sYUFBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxpQkFBUyxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDOUQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogUmVkaXMgQ2xpZW50IE1vZHVsZVxuICogUHJvdmlkZXMgY29ubmVjdGlvbiBtYW5hZ2VtZW50LCB0cmFuc2FjdGlvbiBzdGF0ZSBjYWNoaW5nLCBhbmQgbWVzc2FnZSBkZWR1cGxpY2F0aW9uXG4gKi9cblxuaW1wb3J0IFJlZGlzIGZyb20gJ2lvcmVkaXMnO1xuXG4vLyBEZWNsYXJlIGdsb2JhbCB0eXBlIGZvciBkZXZlbG9wbWVudCBob3QtcmVsb2FkXG5kZWNsYXJlIGdsb2JhbCB7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby12YXJcbiAgdmFyIHJlZGlzOiBSZWRpcyB8IHVuZGVmaW5lZDtcbn1cblxuLy8gUmVkaXMga2V5IHBhdHRlcm5zXG5leHBvcnQgY29uc3QgUkVESVNfS0VZUyA9IHtcbiAgdHJhbnNhY3Rpb246IChpZDogc3RyaW5nKSA9PiBgdHhuOiR7aWR9YCxcbiAgYWxsVHJhbnNhY3Rpb25zOiAndHhuOmFsbCcsXG4gIHByb2Nlc3NlZE1lc3NhZ2U6IChtZXNzYWdlSWQ6IHN0cmluZywgZGlyZWN0aW9uOiBzdHJpbmcpID0+IGBtc2c6JHtkaXJlY3Rpb259OiR7bWVzc2FnZUlkfWAsXG59O1xuXG4vLyBUVEwgdmFsdWVzIGluIHNlY29uZHNcbmV4cG9ydCBjb25zdCBSRURJU19UVEwgPSB7XG4gIHRyYW5zYWN0aW9uOiAyNCAqIDYwICogNjAsIC8vIDI0IGhvdXJzXG4gIHByb2Nlc3NlZE1lc3NhZ2U6IDcgKiAyNCAqIDYwICogNjAsIC8vIDcgZGF5c1xufTtcblxuLy8gQ3JlYXRlIFJlZGlzIGNsaWVudCBzaW5nbGV0b25cbmNvbnN0IGNyZWF0ZVJlZGlzQ2xpZW50ID0gKCkgPT4ge1xuICBjb25zdCByZWRpc1VybCA9IHByb2Nlc3MuZW52LlJFRElTX1VSTCB8fCAncmVkaXM6Ly9sb2NhbGhvc3Q6NjM3OSc7XG4gIFxuICBjb25zdCBjbGllbnQgPSBuZXcgUmVkaXMocmVkaXNVcmwsIHtcbiAgICBtYXhSZXRyaWVzUGVyUmVxdWVzdDogMyxcbiAgICByZXRyeVN0cmF0ZWd5OiAodGltZXMpID0+IHtcbiAgICAgIGlmICh0aW1lcyA+IDEwKSB7XG4gICAgICAgIHJldHVybiBudWxsOyAvLyBTdG9wIHJldHJ5aW5nXG4gICAgICB9XG4gICAgICByZXR1cm4gTWF0aC5taW4odGltZXMgKiAxMDAsIDMwMDApO1xuICAgIH0sXG4gICAgbGF6eUNvbm5lY3Q6IHRydWUsXG4gIH0pO1xuXG4gIGNsaWVudC5vbignZXJyb3InLCAoZXJyKSA9PiB7XG4gICAgY29uc29sZS5lcnJvcignUmVkaXMgY29ubmVjdGlvbiBlcnJvcjonLCBlcnIpO1xuICB9KTtcblxuICBjbGllbnQub24oJ2Nvbm5lY3QnLCAoKSA9PiB7XG4gICAgY29uc29sZS5sb2coJ1JlZGlzIGNvbm5lY3RlZCcpO1xuICB9KTtcblxuICByZXR1cm4gY2xpZW50O1xufTtcblxuLy8gVXNlIGdsb2JhbCB2YXJpYWJsZSBpbiBkZXZlbG9wbWVudCB0byBwcmV2ZW50IG11bHRpcGxlIGluc3RhbmNlcyBkdXJpbmcgaG90LXJlbG9hZFxuZXhwb3J0IGNvbnN0IHJlZGlzID0gZ2xvYmFsVGhpcy5yZWRpcyA/PyBjcmVhdGVSZWRpc0NsaWVudCgpO1xuXG5pZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykge1xuICBnbG9iYWxUaGlzLnJlZGlzID0gcmVkaXM7XG59XG5cbi8qKlxuICogQ2hlY2sgaWYgUmVkaXMgaXMgY29ubmVjdGVkXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjaGVja1JlZGlzQ29ubmVjdGlvbigpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBwb25nID0gYXdhaXQgcmVkaXMucGluZygpO1xuICAgIHJldHVybiBwb25nID09PSAnUE9ORyc7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignUmVkaXMgY29ubmVjdGlvbiBjaGVjayBmYWlsZWQ6JywgZXJyb3IpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vKipcbiAqIENvbm5lY3QgUmVkaXMgY2xpZW50IGV4cGxpY2l0bHlcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNvbm5lY3RSZWRpcygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgaWYgKHJlZGlzLnN0YXR1cyAhPT0gJ3JlYWR5Jykge1xuICAgIGF3YWl0IHJlZGlzLmNvbm5lY3QoKTtcbiAgfVxufVxuXG4vKipcbiAqIERpc2Nvbm5lY3QgUmVkaXMgY2xpZW50IChmb3IgZ3JhY2VmdWwgc2h1dGRvd24pXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkaXNjb25uZWN0UmVkaXMoKTogUHJvbWlzZTx2b2lkPiB7XG4gIGF3YWl0IHJlZGlzLnF1aXQoKTtcbn1cblxuLy8gPT09PT09PT09PT09PT09PT09PT0gVHJhbnNhY3Rpb24gU3RhdGUgT3BlcmF0aW9ucyA9PT09PT09PT09PT09PT09PT09PVxuXG5leHBvcnQgaW50ZXJmYWNlIFRyYW5zYWN0aW9uU3RhdGUge1xuICB0cmFuc2FjdGlvbl9pZDogc3RyaW5nO1xuICBjYXRhbG9nPzogYW55O1xuICBzZWxlY3RlZE9mZmVyPzogYW55O1xuICBzZWxlY3RlZFF1YW50aXR5PzogbnVtYmVyO1xuICBwcm92aWRlcnM/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICBvcmRlcj86IGFueTtcbiAgZGlzY292ZXJ5Q3JpdGVyaWE/OiBhbnk7XG4gIG1hdGNoaW5nUmVzdWx0cz86IGFueTtcbiAgZXhjbHVkZVByb3ZpZGVySWQ/OiBzdHJpbmcgfCBudWxsO1xuICBidXllcklkPzogc3RyaW5nIHwgbnVsbDtcbiAgZXJyb3I/OiBzdHJpbmc7XG4gIHN0YXR1czogJ0RJU0NPVkVSSU5HJyB8ICdTRUxFQ1RJTkcnIHwgJ0lOSVRJQUxJWklORycgfCAnQ09ORklSTUlORycgfCAnQUNUSVZFJyB8ICdDT01QTEVURUQnO1xuICBjcmVhdGVkX2F0OiBzdHJpbmc7XG4gIHVwZGF0ZWRfYXQ6IHN0cmluZztcbn1cblxuLyoqXG4gKiBDcmVhdGUgYSBuZXcgdHJhbnNhY3Rpb24gc3RhdGUgaW4gUmVkaXNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRyYW5zYWN0aW9uU3RhdGUodHJhbnNhY3Rpb25JZDogc3RyaW5nKTogUHJvbWlzZTxUcmFuc2FjdGlvblN0YXRlPiB7XG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgY29uc3Qgc3RhdGU6IFRyYW5zYWN0aW9uU3RhdGUgPSB7XG4gICAgdHJhbnNhY3Rpb25faWQ6IHRyYW5zYWN0aW9uSWQsXG4gICAgc3RhdHVzOiAnRElTQ09WRVJJTkcnLFxuICAgIGNyZWF0ZWRfYXQ6IG5vdyxcbiAgICB1cGRhdGVkX2F0OiBub3csXG4gIH07XG5cbiAgY29uc3Qga2V5ID0gUkVESVNfS0VZUy50cmFuc2FjdGlvbih0cmFuc2FjdGlvbklkKTtcbiAgYXdhaXQgcmVkaXMuc2V0KGtleSwgSlNPTi5zdHJpbmdpZnkoc3RhdGUpLCAnRVgnLCBSRURJU19UVEwudHJhbnNhY3Rpb24pO1xuICBhd2FpdCByZWRpcy5zYWRkKFJFRElTX0tFWVMuYWxsVHJhbnNhY3Rpb25zLCB0cmFuc2FjdGlvbklkKTtcblxuICByZXR1cm4gc3RhdGU7XG59XG5cbi8qKlxuICogR2V0IHRyYW5zYWN0aW9uIHN0YXRlIGZyb20gUmVkaXNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFRyYW5zYWN0aW9uU3RhdGUodHJhbnNhY3Rpb25JZDogc3RyaW5nKTogUHJvbWlzZTxUcmFuc2FjdGlvblN0YXRlIHwgbnVsbD4ge1xuICBjb25zdCBrZXkgPSBSRURJU19LRVlTLnRyYW5zYWN0aW9uKHRyYW5zYWN0aW9uSWQpO1xuICBjb25zdCBkYXRhID0gYXdhaXQgcmVkaXMuZ2V0KGtleSk7XG4gIFxuICBpZiAoIWRhdGEpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHJldHVybiBKU09OLnBhcnNlKGRhdGEpIGFzIFRyYW5zYWN0aW9uU3RhdGU7XG59XG5cbi8qKlxuICogVXBkYXRlIHRyYW5zYWN0aW9uIHN0YXRlIGluIFJlZGlzXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGRhdGVUcmFuc2FjdGlvblN0YXRlKFxuICB0cmFuc2FjdGlvbklkOiBzdHJpbmcsXG4gIHVwZGF0ZXM6IFBhcnRpYWw8T21pdDxUcmFuc2FjdGlvblN0YXRlLCAndHJhbnNhY3Rpb25faWQnIHwgJ2NyZWF0ZWRfYXQnPj5cbik6IFByb21pc2U8VHJhbnNhY3Rpb25TdGF0ZSB8IG51bGw+IHtcbiAgY29uc3Qga2V5ID0gUkVESVNfS0VZUy50cmFuc2FjdGlvbih0cmFuc2FjdGlvbklkKTtcbiAgY29uc3QgZGF0YSA9IGF3YWl0IHJlZGlzLmdldChrZXkpO1xuICBcbiAgaWYgKCFkYXRhKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCBzdGF0ZSA9IEpTT04ucGFyc2UoZGF0YSkgYXMgVHJhbnNhY3Rpb25TdGF0ZTtcbiAgY29uc3QgdXBkYXRlZFN0YXRlOiBUcmFuc2FjdGlvblN0YXRlID0ge1xuICAgIC4uLnN0YXRlLFxuICAgIC4uLnVwZGF0ZXMsXG4gICAgdXBkYXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICB9O1xuXG4gIGF3YWl0IHJlZGlzLnNldChrZXksIEpTT04uc3RyaW5naWZ5KHVwZGF0ZWRTdGF0ZSksICdFWCcsIFJFRElTX1RUTC50cmFuc2FjdGlvbik7XG4gIFxuICByZXR1cm4gdXBkYXRlZFN0YXRlO1xufVxuXG4vKipcbiAqIEdldCBhbGwgdHJhbnNhY3Rpb24gc3RhdGVzIGZyb20gUmVkaXNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEFsbFRyYW5zYWN0aW9uU3RhdGVzKCk6IFByb21pc2U8VHJhbnNhY3Rpb25TdGF0ZVtdPiB7XG4gIGNvbnN0IHRyYW5zYWN0aW9uSWRzID0gYXdhaXQgcmVkaXMuc21lbWJlcnMoUkVESVNfS0VZUy5hbGxUcmFuc2FjdGlvbnMpO1xuICBcbiAgaWYgKHRyYW5zYWN0aW9uSWRzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIGNvbnN0IGtleXMgPSB0cmFuc2FjdGlvbklkcy5tYXAoaWQgPT4gUkVESVNfS0VZUy50cmFuc2FjdGlvbihpZCkpO1xuICBjb25zdCB2YWx1ZXMgPSBhd2FpdCByZWRpcy5tZ2V0KGtleXMpO1xuXG4gIGNvbnN0IHN0YXRlczogVHJhbnNhY3Rpb25TdGF0ZVtdID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgdmFsdWUgPSB2YWx1ZXNbaV07XG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICBzdGF0ZXMucHVzaChKU09OLnBhcnNlKHZhbHVlKSBhcyBUcmFuc2FjdGlvblN0YXRlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ2xlYW4gdXAgc3RhbGUgcmVmZXJlbmNlXG4gICAgICBhd2FpdCByZWRpcy5zcmVtKFJFRElTX0tFWVMuYWxsVHJhbnNhY3Rpb25zLCB0cmFuc2FjdGlvbklkc1tpXSk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHN0YXRlcztcbn1cblxuLyoqXG4gKiBDbGVhciBhbGwgdHJhbnNhY3Rpb24gc3RhdGVzIGZyb20gUmVkaXNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNsZWFyQWxsVHJhbnNhY3Rpb25TdGF0ZXMoKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IHRyYW5zYWN0aW9uSWRzID0gYXdhaXQgcmVkaXMuc21lbWJlcnMoUkVESVNfS0VZUy5hbGxUcmFuc2FjdGlvbnMpO1xuICBcbiAgaWYgKHRyYW5zYWN0aW9uSWRzLmxlbmd0aCA+IDApIHtcbiAgICBjb25zdCBrZXlzID0gdHJhbnNhY3Rpb25JZHMubWFwKGlkID0+IFJFRElTX0tFWVMudHJhbnNhY3Rpb24oaWQpKTtcbiAgICBhd2FpdCByZWRpcy5kZWwoLi4ua2V5cyk7XG4gIH1cbiAgXG4gIGF3YWl0IHJlZGlzLmRlbChSRURJU19LRVlTLmFsbFRyYW5zYWN0aW9ucyk7XG59XG5cbi8vID09PT09PT09PT09PT09PT09PT09IE1lc3NhZ2UgRGVkdXBsaWNhdGlvbiBPcGVyYXRpb25zID09PT09PT09PT09PT09PT09PT09XG5cbi8qKlxuICogQ2hlY2sgaWYgYSBtZXNzYWdlIGhhcyBhbHJlYWR5IGJlZW4gcHJvY2Vzc2VkIChmb3IgZGVkdXBsaWNhdGlvbilcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGlzTWVzc2FnZVByb2Nlc3NlZChtZXNzYWdlSWQ6IHN0cmluZywgZGlyZWN0aW9uOiBzdHJpbmcgPSAnSU5CT1VORCcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgY29uc3Qga2V5ID0gUkVESVNfS0VZUy5wcm9jZXNzZWRNZXNzYWdlKG1lc3NhZ2VJZCwgZGlyZWN0aW9uKTtcbiAgY29uc3QgZXhpc3RzID0gYXdhaXQgcmVkaXMuZXhpc3RzKGtleSk7XG4gIHJldHVybiBleGlzdHMgPT09IDE7XG59XG5cbi8qKlxuICogTWFyayBhIG1lc3NhZ2UgYXMgcHJvY2Vzc2VkXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtYXJrTWVzc2FnZVByb2Nlc3NlZChtZXNzYWdlSWQ6IHN0cmluZywgZGlyZWN0aW9uOiBzdHJpbmcgPSAnSU5CT1VORCcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3Qga2V5ID0gUkVESVNfS0VZUy5wcm9jZXNzZWRNZXNzYWdlKG1lc3NhZ2VJZCwgZGlyZWN0aW9uKTtcbiAgYXdhaXQgcmVkaXMuc2V0KGtleSwgJzEnLCAnRVgnLCBSRURJU19UVEwucHJvY2Vzc2VkTWVzc2FnZSk7XG59XG5cbmV4cG9ydCB0eXBlIHsgUmVkaXMgfTtcbiJdfQ==