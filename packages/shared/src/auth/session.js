"use strict";
/**
 * Session Management Service
 * Handles session creation, validation, and cleanup
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SESSION_REDIS_KEYS = exports.SESSION_CONFIG = void 0;
exports.generateSessionToken = generateSessionToken;
exports.createSession = createSession;
exports.getSession = getSession;
exports.refreshSession = refreshSession;
exports.deleteSession = deleteSession;
exports.deleteAllUserSessions = deleteAllUserSessions;
exports.getUserSessions = getUserSessions;
exports.cleanupExpiredSessions = cleanupExpiredSessions;
const crypto_1 = __importDefault(require("crypto"));
const prisma_1 = require("../db/prisma");
const redis_1 = require("../db/redis");
// Session Configuration
exports.SESSION_CONFIG = {
    tokenLength: 64, // 64 bytes = 128 hex chars
    expiryDays: parseInt(process.env.SESSION_EXPIRY_DAYS || '7'),
    refreshThresholdDays: 1, // Refresh if less than this many days left
};
// Redis key patterns
exports.SESSION_REDIS_KEYS = {
    session: (token) => `session:${token}`,
    userSessions: (userId) => `user:sessions:${userId}`,
};
/**
 * Generate a secure session token
 */
function generateSessionToken() {
    return crypto_1.default.randomBytes(exports.SESSION_CONFIG.tokenLength).toString('hex');
}
/**
 * Create a new session
 */
async function createSession(options) {
    const { userId, deviceInfo, ipAddress } = options;
    const token = generateSessionToken();
    const expiresAt = new Date(Date.now() + exports.SESSION_CONFIG.expiryDays * 24 * 60 * 60 * 1000);
    // Create session in database
    const session = await prisma_1.prisma.session.create({
        data: {
            userId,
            token,
            deviceInfo,
            ipAddress,
            expiresAt,
        },
    });
    // Cache session in Redis for fast lookups
    const sessionData = JSON.stringify({
        id: session.id,
        userId: session.userId,
        expiresAt: session.expiresAt.toISOString(),
    });
    const ttlSeconds = Math.floor((expiresAt.getTime() - Date.now()) / 1000);
    await redis_1.redis.setex(exports.SESSION_REDIS_KEYS.session(token), ttlSeconds, sessionData);
    // Track user's sessions
    await redis_1.redis.sadd(exports.SESSION_REDIS_KEYS.userSessions(userId), token);
    return {
        id: session.id,
        userId: session.userId,
        token: session.token,
        deviceInfo: session.deviceInfo || undefined,
        ipAddress: session.ipAddress || undefined,
        expiresAt: session.expiresAt,
        createdAt: session.createdAt,
    };
}
/**
 * Validate and get session by token
 */
async function getSession(token) {
    // Try Redis first
    const cachedSession = await redis_1.redis.get(exports.SESSION_REDIS_KEYS.session(token));
    if (cachedSession) {
        const data = JSON.parse(cachedSession);
        const expiresAt = new Date(data.expiresAt);
        if (expiresAt > new Date()) {
            // Session is valid
            return {
                id: data.id,
                userId: data.userId,
                token,
                expiresAt,
                createdAt: new Date(), // Approximation for cached session
            };
        }
    }
    // Check database
    const session = await prisma_1.prisma.session.findUnique({
        where: { token },
    });
    if (!session) {
        return null;
    }
    // Check expiry
    if (session.expiresAt < new Date()) {
        // Session expired - clean up
        await deleteSession(token);
        return null;
    }
    // Re-cache in Redis
    const ttlSeconds = Math.floor((session.expiresAt.getTime() - Date.now()) / 1000);
    if (ttlSeconds > 0) {
        const sessionData = JSON.stringify({
            id: session.id,
            userId: session.userId,
            expiresAt: session.expiresAt.toISOString(),
        });
        await redis_1.redis.setex(exports.SESSION_REDIS_KEYS.session(token), ttlSeconds, sessionData);
    }
    return {
        id: session.id,
        userId: session.userId,
        token: session.token,
        deviceInfo: session.deviceInfo || undefined,
        ipAddress: session.ipAddress || undefined,
        expiresAt: session.expiresAt,
        createdAt: session.createdAt,
    };
}
/**
 * Refresh session if needed (extend expiry)
 */
async function refreshSession(token) {
    const session = await getSession(token);
    if (!session) {
        return null;
    }
    // Check if refresh is needed
    const remainingDays = (session.expiresAt.getTime() - Date.now()) / (24 * 60 * 60 * 1000);
    if (remainingDays > exports.SESSION_CONFIG.refreshThresholdDays) {
        // No refresh needed
        return session;
    }
    // Extend session
    const newExpiresAt = new Date(Date.now() + exports.SESSION_CONFIG.expiryDays * 24 * 60 * 60 * 1000);
    await prisma_1.prisma.session.update({
        where: { token },
        data: { expiresAt: newExpiresAt },
    });
    // Update Redis cache
    const ttlSeconds = Math.floor((newExpiresAt.getTime() - Date.now()) / 1000);
    const sessionData = JSON.stringify({
        id: session.id,
        userId: session.userId,
        expiresAt: newExpiresAt.toISOString(),
    });
    await redis_1.redis.setex(exports.SESSION_REDIS_KEYS.session(token), ttlSeconds, sessionData);
    return {
        ...session,
        expiresAt: newExpiresAt,
    };
}
/**
 * Delete a session (logout)
 */
async function deleteSession(token) {
    // Get session to find user
    const session = await prisma_1.prisma.session.findUnique({
        where: { token },
    });
    // Delete from Redis
    await redis_1.redis.del(exports.SESSION_REDIS_KEYS.session(token));
    // Remove from user's sessions set
    if (session) {
        await redis_1.redis.srem(exports.SESSION_REDIS_KEYS.userSessions(session.userId), token);
    }
    // Delete from database
    const result = await prisma_1.prisma.session.deleteMany({
        where: { token },
    });
    return result.count > 0;
}
/**
 * Delete all sessions for a user (logout everywhere)
 */
async function deleteAllUserSessions(userId) {
    // Get all user's sessions
    const sessions = await prisma_1.prisma.session.findMany({
        where: { userId },
        select: { token: true },
    });
    // Delete from Redis
    for (const session of sessions) {
        await redis_1.redis.del(exports.SESSION_REDIS_KEYS.session(session.token));
    }
    await redis_1.redis.del(exports.SESSION_REDIS_KEYS.userSessions(userId));
    // Delete from database
    const result = await prisma_1.prisma.session.deleteMany({
        where: { userId },
    });
    return result.count;
}
/**
 * Get all active sessions for a user
 */
async function getUserSessions(userId) {
    const sessions = await prisma_1.prisma.session.findMany({
        where: {
            userId,
            expiresAt: { gt: new Date() },
        },
        orderBy: { createdAt: 'desc' },
    });
    return sessions.map(s => ({
        id: s.id,
        userId: s.userId,
        token: s.token,
        deviceInfo: s.deviceInfo || undefined,
        ipAddress: s.ipAddress || undefined,
        expiresAt: s.expiresAt,
        createdAt: s.createdAt,
    }));
}
/**
 * Clean up expired sessions (call periodically)
 */
async function cleanupExpiredSessions() {
    const result = await prisma_1.prisma.session.deleteMany({
        where: {
            expiresAt: { lt: new Date() },
        },
    });
    return result.count;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Vzc2lvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNlc3Npb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7Ozs7O0FBc0NILG9EQUVDO0FBS0Qsc0NBdUNDO0FBS0QsZ0NBd0RDO0FBS0Qsd0NBb0NDO0FBS0Qsc0NBb0JDO0FBS0Qsc0RBbUJDO0FBS0QsMENBa0JDO0FBS0Qsd0RBT0M7QUE1UUQsb0RBQTRCO0FBQzVCLHlDQUFzQztBQUN0Qyx1Q0FBb0M7QUFFcEMsd0JBQXdCO0FBQ1gsUUFBQSxjQUFjLEdBQUc7SUFDNUIsV0FBVyxFQUFFLEVBQUUsRUFBRSwyQkFBMkI7SUFDNUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLEdBQUcsQ0FBQztJQUM1RCxvQkFBb0IsRUFBRSxDQUFDLEVBQUUsMkNBQTJDO0NBQ3JFLENBQUM7QUFFRixxQkFBcUI7QUFDUixRQUFBLGtCQUFrQixHQUFHO0lBQ2hDLE9BQU8sRUFBRSxDQUFDLEtBQWEsRUFBRSxFQUFFLENBQUMsV0FBVyxLQUFLLEVBQUU7SUFDOUMsWUFBWSxFQUFFLENBQUMsTUFBYyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsTUFBTSxFQUFFO0NBQzVELENBQUM7QUFrQkY7O0dBRUc7QUFDSCxTQUFnQixvQkFBb0I7SUFDbEMsT0FBTyxnQkFBTSxDQUFDLFdBQVcsQ0FBQyxzQkFBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN4RSxDQUFDO0FBRUQ7O0dBRUc7QUFDSSxLQUFLLFVBQVUsYUFBYSxDQUFDLE9BQTZCO0lBQy9ELE1BQU0sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxHQUFHLE9BQU8sQ0FBQztJQUVsRCxNQUFNLEtBQUssR0FBRyxvQkFBb0IsRUFBRSxDQUFDO0lBQ3JDLE1BQU0sU0FBUyxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxH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QUM7UUFDN0MsS0FBSyxFQUFFO1lBQ0wsU0FBUyxFQUFFLEVBQUUsRUFBRSxFQUFFLElBQUksSUFBSSxFQUFFLEVBQUU7U0FDOUI7S0FDRixDQUFDLENBQUM7SUFDSCxPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUM7QUFDdEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogU2Vzc2lvbiBNYW5hZ2VtZW50IFNlcnZpY2VcbiAqIEhhbmRsZXMgc2Vzc2lvbiBjcmVhdGlvbiwgdmFsaWRhdGlvbiwgYW5kIGNsZWFudXBcbiAqL1xuXG5pbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgeyBwcmlzbWEgfSBmcm9tICcuLi9kYi9wcmlzbWEnO1xuaW1wb3J0IHsgcmVkaXMgfSBmcm9tICcuLi9kYi9yZWRpcyc7XG5cbi8vIFNlc3Npb24gQ29uZmlndXJhdGlvblxuZXhwb3J0IGNvbnN0IFNFU1NJT05fQ09ORklHID0ge1xuICB0b2tlbkxlbmd0aDogNjQsIC8vIDY0IGJ5dGVzID0gMTI4IGhleCBjaGFyc1xuICBleHBpcnlEYXlzOiBwYXJzZUludChwcm9jZXNzLmVudi5TRVNTSU9OX0VYUElSWV9EQVlTIHx8ICc3JyksXG4gIHJlZnJlc2hUaHJlc2hvbGREYXlzOiAxLCAvLyBSZWZyZXNoIGlmIGxlc3MgdGhhbiB0aGlzIG1hbnkgZGF5cyBsZWZ0XG59O1xuXG4vLyBSZWRpcyBrZXkgcGF0dGVybnNcbmV4cG9ydCBjb25zdCBTRVNTSU9OX1JFRElTX0tFWVMgPSB7XG4gIHNlc3Npb246ICh0b2tlbjogc3RyaW5nKSA9PiBgc2Vzc2lvbjoke3Rva2VufWAsXG4gIHVzZXJTZXNzaW9uczogKHVzZXJJZDogc3RyaW5nKSA9PiBgdXNlcjpzZXNzaW9uczoke3VzZXJJZH1gLFxufTtcblxuZXhwb3J0IGludGVyZmFjZSBTZXNzaW9uSW5mbyB7XG4gIGlkOiBzdHJpbmc7XG4gIHVzZXJJZDogc3RyaW5nO1xuICB0b2tlbjogc3RyaW5nO1xuICBkZXZpY2VJbmZvPzogc3RyaW5nO1xuICBpcEFkZHJlc3M/OiBzdHJpbmc7XG4gIGV4cGlyZXNBdDogRGF0ZTtcbiAgY3JlYXRlZEF0OiBEYXRlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENyZWF0ZVNlc3Npb25PcHRpb25zIHtcbiAgdXNlcklkOiBzdHJpbmc7XG4gIGRldmljZUluZm8/OiBzdHJpbmc7XG4gIGlwQWRkcmVzcz86IHN0cmluZztcbn1cblxuLyoqXG4gKiBHZW5lcmF0ZSBhIHNlY3VyZSBzZXNzaW9uIHRva2VuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZVNlc3Npb25Ub2tlbigpOiBzdHJpbmcge1xuICByZXR1cm4gY3J5cHRvLnJhbmRvbUJ5dGVzKFNFU1NJT05fQ09ORklHLnRva2VuTGVuZ3RoKS50b1N0cmluZygnaGV4Jyk7XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgbmV3IHNlc3Npb25cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVNlc3Npb24ob3B0aW9uczogQ3JlYXRlU2Vzc2lvbk9wdGlvbnMpOiBQcm9taXNlPFNlc3Npb25JbmZvPiB7XG4gIGNvbnN0IHsgdXNlcklkLCBkZXZpY2VJbmZvLCBpcEFkZHJlc3MgfSA9IG9wdGlvbnM7XG4gIFxuICBjb25zdCB0b2tlbiA9IGdlbmVyYXRlU2Vzc2lvblRva2VuKCk7XG4gIGNvbnN0IGV4cGlyZXNBdCA9IG5ldyBEYXRlKERhdGUubm93KCkgKyBTRVNTSU9OX0NPTkZJRy5leHBpcnlEYXlzICogMjQgKiA2MCAqIDYwICogMTAwMCk7XG5cbiAgLy8gQ3JlYXRlIHNlc3Npb24gaW4gZGF0YWJhc2VcbiAgY29uc3Qgc2Vzc2lvbiA9IGF3YWl0IHByaXNtYS5zZXNzaW9uLmNyZWF0ZSh7XG4gICAgZGF0YToge1xuICAgICAgdXNlcklkLFxuICAgICAgdG9rZW4sXG4gICAgICBkZXZpY2VJbmZvLFxuICAgICAgaXBBZGRyZXNzLFxuICAgICAgZXhwaXJlc0F0LFxuICAgIH0sXG4gIH0pO1xuXG4gIC8vIENhY2hlIHNlc3Npb24gaW4gUmVkaXMgZm9yIGZhc3QgbG9va3Vwc1xuICBjb25zdCBzZXNzaW9uRGF0YSA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICBpZDogc2Vzc2lvbi5pZCxcbiAgICB1c2VySWQ6IHNlc3Npb24udXNlcklkLFxuICAgIGV4cGlyZXNBdDogc2Vzc2lvbi5leHBpcmVzQXQudG9JU09TdHJpbmcoKSxcbiAgfSk7XG4gIFxuICBjb25zdCB0dGxTZWNvbmRzID0gTWF0aC5mbG9vcigoZXhwaXJlc0F0LmdldFRpbWUoKSAtIERhdGUubm93KCkpIC8gMTAwMCk7XG4gIGF3YWl0IHJlZGlzLnNldGV4KFNFU1NJT05fUkVESVNfS0VZUy5zZXNzaW9uKHRva2VuKSwgdHRsU2Vjb25kcywgc2Vzc2lvbkRhdGEpO1xuXG4gIC8vIFRyYWNrIHVzZXIncyBzZXNzaW9uc1xuICBhd2FpdCByZWRpcy5zYWRkKFNFU1NJT05fUkVESVNfS0VZUy51c2VyU2Vzc2lvbnModXNlcklkKSwgdG9rZW4pO1xuXG4gIHJldHVybiB7XG4gICAgaWQ6IHNlc3Npb24uaWQsXG4gICAgdXNlcklkOiBzZXNzaW9uLnVzZXJJZCxcbiAgICB0b2tlbjogc2Vzc2lvbi50b2tlbixcbiAgICBkZXZpY2VJbmZvOiBzZXNzaW9uLmRldmljZUluZm8gfHwgdW5kZWZpbmVkLFxuICAgIGlwQWRkcmVzczogc2Vzc2lvbi5pcEFkZHJlc3MgfHwgdW5kZWZpbmVkLFxuICAgIGV4cGlyZXNBdDogc2Vzc2lvbi5leHBpcmVzQXQsXG4gICAgY3JlYXRlZEF0OiBzZXNzaW9uLmNyZWF0ZWRBdCxcbiAgfTtcbn1cblxuLyoqXG4gKiBWYWxpZGF0ZSBhbmQgZ2V0IHNlc3Npb24gYnkgdG9rZW5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNlc3Npb24odG9rZW46IHN0cmluZyk6IFByb21pc2U8U2Vzc2lvbkluZm8gfCBudWxsPiB7XG4gIC8vIFRyeSBSZWRpcyBmaXJzdFxuICBjb25zdCBjYWNoZWRTZXNzaW9uID0gYXdhaXQgcmVkaXMuZ2V0KFNFU1NJT05fUkVESVNfS0VZUy5zZXNzaW9uKHRva2VuKSk7XG4gIFxuICBpZiAoY2FjaGVkU2Vzc2lvbikge1xuICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKGNhY2hlZFNlc3Npb24pO1xuICAgIGNvbnN0IGV4cGlyZXNBdCA9IG5ldyBEYXRlKGRhdGEuZXhwaXJlc0F0KTtcbiAgICBcbiAgICBpZiAoZXhwaXJlc0F0ID4gbmV3IERhdGUoKSkge1xuICAgICAgLy8gU2Vzc2lvbiBpcyB2YWxpZFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaWQ6IGRhdGEuaWQsXG4gICAgICAgIHVzZXJJZDogZGF0YS51c2VySWQsXG4gICAgICAgIHRva2VuLFxuICAgICAgICBleHBpcmVzQXQsXG4gICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSwgLy8gQXBwcm94aW1hdGlvbiBmb3IgY2FjaGVkIHNlc3Npb25cbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgLy8gQ2hlY2sgZGF0YWJhc2VcbiAgY29uc3Qgc2Vzc2lvbiA9IGF3YWl0IHByaXNtYS5zZXNzaW9uLmZpbmRVbmlxdWUoe1xuICAgIHdoZXJlOiB7IHRva2VuIH0sXG4gIH0pO1xuXG4gIGlmICghc2Vzc2lvbikge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgLy8gQ2hlY2sgZXhwaXJ5XG4gIGlmIChzZXNzaW9uLmV4cGlyZXNBdCA8IG5ldyBEYXRlKCkpIHtcbiAgICAvLyBTZXNzaW9uIGV4cGlyZWQgLSBjbGVhbiB1cFxuICAgIGF3YWl0IGRlbGV0ZVNlc3Npb24odG9rZW4pO1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgLy8gUmUtY2FjaGUgaW4gUmVkaXNcbiAgY29uc3QgdHRsU2Vjb25kcyA9IE1hdGguZmxvb3IoKHNlc3Npb24uZXhwaXJlc0F0LmdldFRpbWUoKSAtIERhdGUubm93KCkpIC8gMTAwMCk7XG4gIGlmICh0dGxTZWNvbmRzID4gMCkge1xuICAgIGNvbnN0IHNlc3Npb25EYXRhID0gSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgaWQ6IHNlc3Npb24uaWQsXG4gICAgICB1c2VySWQ6IHNlc3Npb24udXNlcklkLFxuICAgICAgZXhwaXJlc0F0OiBzZXNzaW9uLmV4cGlyZXNBdC50b0lTT1N0cmluZygpLFxuICAgIH0pO1xuICAgIGF3YWl0IHJlZGlzLnNldGV4KFNFU1NJT05fUkVESVNfS0VZUy5zZXNzaW9uKHRva2VuKSwgdHRsU2Vjb25kcywgc2Vzc2lvbkRhdGEpO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBpZDogc2Vzc2lvbi5pZCxcbiAgICB1c2VySWQ6IHNlc3Npb24udXNlcklkLFxuICAgIHRva2VuOiBzZXNzaW9uLnRva2VuLFxuICAgIGRldmljZUluZm86IHNlc3Npb24uZGV2aWNlSW5mbyB8fCB1bmRlZmluZWQsXG4gICAgaXBBZGRyZXNzOiBzZXNzaW9uLmlwQWRkcmVzcyB8fCB1bmRlZmluZWQsXG4gICAgZXhwaXJlc0F0OiBzZXNzaW9uLmV4cGlyZXNBdCxcbiAgICBjcmVhdGVkQXQ6IHNlc3Npb24uY3JlYXRlZEF0LFxuICB9O1xufVxuXG4vKipcbiAqIFJlZnJlc2ggc2Vzc2lvbiBpZiBuZWVkZWQgKGV4dGVuZCBleHBpcnkpXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZWZyZXNoU2Vzc2lvbih0b2tlbjogc3RyaW5nKTogUHJvbWlzZTxTZXNzaW9uSW5mbyB8IG51bGw+IHtcbiAgY29uc3Qgc2Vzc2lvbiA9IGF3YWl0IGdldFNlc3Npb24odG9rZW4pO1xuICBcbiAgaWYgKCFzZXNzaW9uKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvLyBDaGVjayBpZiByZWZyZXNoIGlzIG5lZWRlZFxuICBjb25zdCByZW1haW5pbmdEYXlzID0gKHNlc3Npb24uZXhwaXJlc0F0LmdldFRpbWUoKSAtIERhdGUubm93KCkpIC8gKDI0ICogNjAgKiA2MCAqIDEwMDApO1xuICBcbiAgaWYgKHJlbWFpbmluZ0RheXMgPiBTRVNTSU9OX0NPTkZJRy5yZWZyZXNoVGhyZXNob2xkRGF5cykge1xuICAgIC8vIE5vIHJlZnJlc2ggbmVlZGVkXG4gICAgcmV0dXJuIHNlc3Npb247XG4gIH1cblxuICAvLyBFeHRlbmQgc2Vzc2lvblxuICBjb25zdCBuZXdFeHBpcmVzQXQgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgU0VTU0lPTl9DT05GSUcuZXhwaXJ5RGF5cyAqIDI0ICogNjAgKiA2MCAqIDEwMDApO1xuXG4gIGF3YWl0IHByaXNtYS5zZXNzaW9uLnVwZGF0ZSh7XG4gICAgd2hlcmU6IHsgdG9rZW4gfSxcbiAgICBkYXRhOiB7IGV4cGlyZXNBdDogbmV3RXhwaXJlc0F0IH0sXG4gIH0pO1xuXG4gIC8vIFVwZGF0ZSBSZWRpcyBjYWNoZVxuICBjb25zdCB0dGxTZWNvbmRzID0gTWF0aC5mbG9vcigobmV3RXhwaXJlc0F0LmdldFRpbWUoKSAtIERhdGUubm93KCkpIC8gMTAwMCk7XG4gIGNvbnN0IHNlc3Npb25EYXRhID0gSlNPTi5zdHJpbmdpZnkoe1xuICAgIGlkOiBzZXNzaW9uLmlkLFxuICAgIHVzZXJJZDogc2Vzc2lvbi51c2VySWQsXG4gICAgZXhwaXJlc0F0OiBuZXdFeHBpcmVzQXQudG9JU09TdHJpbmcoKSxcbiAgfSk7XG4gIGF3YWl0IHJlZGlzLnNldGV4KFNFU1NJT05fUkVESVNfS0VZUy5zZXNzaW9uKHRva2VuKSwgdHRsU2Vjb25kcywgc2Vzc2lvbkRhdGEpO1xuXG4gIHJldHVybiB7XG4gICAgLi4uc2Vzc2lvbixcbiAgICBleHBpcmVzQXQ6IG5ld0V4cGlyZXNBdCxcbiAgfTtcbn1cblxuLyoqXG4gKiBEZWxldGUgYSBzZXNzaW9uIChsb2dvdXQpXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWxldGVTZXNzaW9uKHRva2VuOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgLy8gR2V0IHNlc3Npb24gdG8gZmluZCB1c2VyXG4gIGNvbnN0IHNlc3Npb24gPSBhd2FpdCBwcmlzbWEuc2Vzc2lvbi5maW5kVW5pcXVlKHtcbiAgICB3aGVyZTogeyB0b2tlbiB9LFxuICB9KTtcblxuICAvLyBEZWxldGUgZnJvbSBSZWRpc1xuICBhd2FpdCByZWRpcy5kZWwoU0VTU0lPTl9SRURJU19LRVlTLnNlc3Npb24odG9rZW4pKTtcblxuICAvLyBSZW1vdmUgZnJvbSB1c2VyJ3Mgc2Vzc2lvbnMgc2V0XG4gIGlmIChzZXNzaW9uKSB7XG4gICAgYXdhaXQgcmVkaXMuc3JlbShTRVNTSU9OX1JFRElTX0tFWVMudXNlclNlc3Npb25zKHNlc3Npb24udXNlcklkKSwgdG9rZW4pO1xuICB9XG5cbiAgLy8gRGVsZXRlIGZyb20gZGF0YWJhc2VcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcHJpc21hLnNlc3Npb24uZGVsZXRlTWFueSh7XG4gICAgd2hlcmU6IHsgdG9rZW4gfSxcbiAgfSk7XG5cbiAgcmV0dXJuIHJlc3VsdC5jb3VudCA+IDA7XG59XG5cbi8qKlxuICogRGVsZXRlIGFsbCBzZXNzaW9ucyBmb3IgYSB1c2VyIChsb2dvdXQgZXZlcnl3aGVyZSlcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZUFsbFVzZXJTZXNzaW9ucyh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8bnVtYmVyPiB7XG4gIC8vIEdldCBhbGwgdXNlcidzIHNlc3Npb25zXG4gIGNvbnN0IHNlc3Npb25zID0gYXdhaXQgcHJpc21hLnNlc3Npb24uZmluZE1hbnkoe1xuICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICAgIHNlbGVjdDogeyB0b2tlbjogdHJ1ZSB9LFxuICB9KTtcblxuICAvLyBEZWxldGUgZnJvbSBSZWRpc1xuICBmb3IgKGNvbnN0IHNlc3Npb24gb2Ygc2Vzc2lvbnMpIHtcbiAgICBhd2FpdCByZWRpcy5kZWwoU0VTU0lPTl9SRURJU19LRVlTLnNlc3Npb24oc2Vzc2lvbi50b2tlbikpO1xuICB9XG4gIGF3YWl0IHJlZGlzLmRlbChTRVNTSU9OX1JFRElTX0tFWVMudXNlclNlc3Npb25zKHVzZXJJZCkpO1xuXG4gIC8vIERlbGV0ZSBmcm9tIGRhdGFiYXNlXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHByaXNtYS5zZXNzaW9uLmRlbGV0ZU1hbnkoe1xuICAgIHdoZXJlOiB7IHVzZXJJZCB9LFxuICB9KTtcblxuICByZXR1cm4gcmVzdWx0LmNvdW50O1xufVxuXG4vKipcbiAqIEdldCBhbGwgYWN0aXZlIHNlc3Npb25zIGZvciBhIHVzZXJcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFVzZXJTZXNzaW9ucyh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8U2Vzc2lvbkluZm9bXT4ge1xuICBjb25zdCBzZXNzaW9ucyA9IGF3YWl0IHByaXNtYS5zZXNzaW9uLmZpbmRNYW55KHtcbiAgICB3aGVyZToge1xuICAgICAgdXNlcklkLFxuICAgICAgZXhwaXJlc0F0OiB7IGd0OiBuZXcgRGF0ZSgpIH0sXG4gICAgfSxcbiAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0sXG4gIH0pO1xuXG4gIHJldHVybiBzZXNzaW9ucy5tYXAocyA9PiAoe1xuICAgIGlkOiBzLmlkLFxuICAgIHVzZXJJZDogcy51c2VySWQsXG4gICAgdG9rZW46IHMudG9rZW4sXG4gICAgZGV2aWNlSW5mbzogcy5kZXZpY2VJbmZvIHx8IHVuZGVmaW5lZCxcbiAgICBpcEFkZHJlc3M6IHMuaXBBZGRyZXNzIHx8IHVuZGVmaW5lZCxcbiAgICBleHBpcmVzQXQ6IHMuZXhwaXJlc0F0LFxuICAgIGNyZWF0ZWRBdDogcy5jcmVhdGVkQXQsXG4gIH0pKTtcbn1cblxuLyoqXG4gKiBDbGVhbiB1cCBleHBpcmVkIHNlc3Npb25zIChjYWxsIHBlcmlvZGljYWxseSlcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNsZWFudXBFeHBpcmVkU2Vzc2lvbnMoKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcHJpc21hLnNlc3Npb24uZGVsZXRlTWFueSh7XG4gICAgd2hlcmU6IHtcbiAgICAgIGV4cGlyZXNBdDogeyBsdDogbmV3IERhdGUoKSB9LFxuICAgIH0sXG4gIH0pO1xuICByZXR1cm4gcmVzdWx0LmNvdW50O1xufVxuIl19